<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Streaming Converter</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a polished look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Spinning animation for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6; /* Blue spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div class="p-6 sm:p-10 w-full max-w-xl bg-white rounded-xl shadow-2xl transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
            ðŸš€ Large JSON Converter
        </h1>
        <p class="text-center text-gray-500 mb-8">
            Upload your $\approx 100\text{ MB}$ file for fast, memory-safe conversion via the Render API.
        </p>

        <!-- Status Box for messages (will display error/success messages) -->
        <div id="status-box" class="p-4 rounded-lg mb-6 hidden"></div>

        <form id="uploadForm" class="space-y-6">
            
            <!-- File Input Area -->
            <label for="jsonFile" class="block text-sm font-medium text-gray-700">
                Select JSON File (Max 100MB)
            </label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md hover:border-blue-400 transition-colors duration-200">
                <div class="space-y-1 text-center">
                    <!-- File Icon SVG -->
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28m0 0l4 4m-4-4l-4 4m-4-4l-4 4m-4 4h8m-8 0h8m-8 0h8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="flex text-sm text-gray-600">
                        <label for="jsonFile" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                            <span>Upload a file</span>
                            <input id="jsonFile" name="jsonFile" type="file" class="sr-only" accept=".json">
                        </label>
                        <p class="pl-1">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500" id="file-name-display">
                        .json files only
                    </p>
                </div>
            </div>

            <!-- Submit Button and Loading State -->
            <button type="submit" id="submitButton" 
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="buttonText">Start Conversion</span>
                <div id="loadingIndicator" class="spinner ml-3 hidden"></div>
            </button>
        </form>

    </div>

    <script>
        // --- CONFIGURATION ---
        // !!! IMPORTANT !!! REPLACE THIS URL with your actual Render service URL
        // It must point to the /convert endpoint (e.g., https://my-json-converter.onrender.com/convert)
        const API_URL = 'https://your-render-service-url/convert'; 
        // ---------------------

        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('jsonFile');
        const fileNameDisplay = document.getElementById('file-name-display');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusBox = document.getElementById('status-box');

        // State management for displaying status messages
        function setStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-700', 'text-green-700', 'text-blue-700');
            
            if (type === 'error') {
                statusBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusBox.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        // Toggle the button state (disabled, text, spinner)
        function toggleLoading(isLoading) {
            submitButton.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'Processing Large File...';
                loadingIndicator.classList.remove('hidden');
                setStatus('Conversion started. Please wait, this may take up to a few minutes depending on file size and server speed.', 'info');
            } else {
                buttonText.textContent = 'Start Conversion';
                loadingIndicator.classList.add('hidden');
            }
        }

        // Update file name display and enable button when a file is selected
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = e.target.files[0].name;
                submitButton.disabled = false;
                statusBox.classList.add('hidden'); // Clear status when new file selected
            } else {
                fileNameDisplay.textContent = '.json files only';
                submitButton.disabled = true;
            }
        });

        // Initialize button as disabled until a file is selected
        submitButton.disabled = true;

        // Form submission handler to send the file to the Render API
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) {
                setStatus('Please select a JSON file.', 'error');
                return;
            }
            
            toggleLoading(true);

            try {
                // 1. Prepare data for POST request
                const formData = new FormData();
                // 'jsonFile' must match the server's multer field name in server.js
                formData.append('jsonFile', file); 

                // 2. Send request to the deployed API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                });

                // 3. Handle non-successful response (e.g., 400, 500 status codes)
                if (!response.ok) {
                    const errorMessage = await response.text();
                    throw new Error(errorMessage || `Server returned status ${response.status}`);
                }

                // 4. Successful response: Prepare for download
                const blob = await response.blob();
                
                // Get filename from server's response header if available
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'converted_output.json';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?(.+)"?$/i);
                    if (match && match[1]) {
                        filename = match[1];
                    }
                }

                // 5. Trigger the automatic download using a temporary link element
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // 6. Clean up
                window.URL.revokeObjectURL(url);
                a.remove();

                setStatus(`Success! File '${filename}' downloaded.`, 'success');

            } catch (error) {
                console.error('Conversion Failed:', error);
                setStatus(`Conversion failed: ${error.message}. Check the network log for details.`, 'error'); 
            } finally {
                // Reset UI state
                toggleLoading(false);
            }
        });
    </script>
</body>
</html>
